<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="stylesheet" type="text/css" href="exolve-m.css?v1.31"/>
<script src="exolve-m.js?v1.31"></script>
<script src="exolve-from-ipuz.js?v1.31"></script>
<script src="exolve-from-puz.js?v1.31"></script>
<script src="exolve-from-text.js?v1.31"></script>

<style>
.xlvp-wait {
  cursor: wait;
}
#xlvp-player {
  border: 1px solid black;
  width: 100%;
  box-sizing: border-box;
  padding: 20px 4%;
  margin: 20px 0;
  font-size: 16px;
  font-family: monospace;
  background-image: linear-gradient(45deg, #F0F0F0 25%, transparent 25%), linear-gradient(-45deg, #F0F0F0 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #F0F0F0 75%), linear-gradient(-45deg, transparent 75%, #F0F0F0 75%);
  background-size: 40px 40px;
  background-position: 0 0, 0 20px, 20px -20px, -20px 0px;
}
summary {
  text-align: center;
  background: gainsboro;
  padding: 4px;
  border: 1px solid gray;
  cursor: pointer;
  font-size: 70%;
}
pre,
#xlvp-help {
  border: 1px solid gray;
  background: white;
  padding: 8px;
}
#xlvp-text,
#xlvp-chooser {
  margin-top: 10px;
}
.xlvp-hscroll {
  overflow-x: auto;
}
.xlvp-chooser-entry {
  background: white;
  padding: 4px 0px 6px 12px;
  border: 1px solid black;
  cursor: pointer;
}
.xlvp-chooser-entry-sel {
  background: lightgray !important;
}
.xlvp-chooser-entry:hover {
  background: lightgreen;
  border: 1px solid darkgreen;
}
.xlvp-list li + li {
  margin-top: 16px;
}
#xlvp-multiple-msg {
  margin-top: 16px;
  background: lightgreen;
  padding: 4px;
  border-bottom: 1px solid black;
}
#xlvp-save,
#xlvp-view {
  margin-top: 10px;
}
</style>

<title>Exolve Player</title>

</head>
<body>

<div id="xlvp-frame">
</div>

<div id="xlvp-player" ondrop="xlvpDrop(event);" ondragover="xlvpDrag(event);">
  <h2><b>Exolve Player</b></h2>
  <h3><b>Interactively solve a crossword</b></h3>
  <br>
  <ul class="xlvp-list">
    <li><b>Drag and drop a crossword file in these formats: Exolve, ipuz, puz, text</b></li>
    <li><b>Or:</b> <input id="xlvp-file" onchange="xlvpOnOpenFile();" type="file"></input></li>
    <li><b>Or: Enter crossword text (selected from a PDF file, for example):</b>
      <br>
      <div class="xlvp-hscroll">
        <textarea onchange="xlvpSaveState()"
          placeholder='Paste just the clues from the text of a blocked, symmetric (UK-style) crossword here, including the lines that say "Across" and "Down", optionally preceded by Title/Byline/Preamble. Clues can span multiple lines, but if one of those lines starts with a number then please join it up with the previous line. Change the grid width and height below if different.'
          id="xlvp-text" rows="8" cols="80"></textarea>
      </div>
      <div style="margin-top:8px">
        <label for="xlvp-w">Width:</label> <input id="xlvp-w" name="xlvp-w" type="text" size="2" maxlength="2" min="3" max="21" value="15"/>
        <label for="xlvp-h">Height:</label> <input id="xlvp-h" name="xlvp-h" type="text" size="2" maxlength="2" min="3" max="21" value="15"/>
        <button onclick="xlvpOnText()"><b>Try to infer the crossword from the above text</b></button>
      </div>
    <div id="xlvp-chooser" class="xlvphscroll">
      <h3 id="xlvp-multiple-msg">Multiple grids match the text, choose the right one:</h3>
      <div id="xlvp-chooser-strip" class="xlvp-hscroll">
      </div>
    </div></li>
    <li>
      <details>
        <summary>Help</summary>
        <div id="xlvp-help">
          <p>
          You can specify the crossword to be opened by choosing a file to open, or by dragging-and-dropping it onto the player.
          You can also paste plain-text-formatted crosswords into the "Enter crossword text" area.
          Here are some details on the various supported formats:
          </p>
          <p><ul>
            <li><b>Exolve:</b> You can open Exolve-formatted files with exolve-player. Such files have to contain
              a crossword in the Exolve format between "exolve-begin" and "exolve-end" lines. They can be HTML
              files too, as long as the Exolve-formatted data is present in them.</li>
            <li><b>PUZ:</b> You can open <a href="https://code.google.com/archive/p/puz/wikis/FileFormat.wiki">.puz files</a> with exolve-player.
              <li><b>IPUZ:</b> You can open <a href="http://www.ipuz.org/">.ipuz files</a> with exolve-player.
            <li><b>Text:</b> You can open text files or paste the text into the "Enter crossword text" area and
              click on the "Try to infer the crossword from the above text" button. In either case, the
              software will try to figure out the grid from the clue numbers and their enumerations. The text
              should include clues with enumerations, along with the "Across" and "Down" heading lines.
              Grid inference currently works only for standard blocked grids following chequered templates.
              The width and the height of the crossword should be set in the entry fields under the
              "Enter crossword text" area (for pasted text as well as text files).</li>
          </ul></p>
        </div>
      </details>
    </li>
  </ul>
  <div id="xlvp-links" style="font-size:80%">
    <p><b>Links</b></p>
    <p><a href="https://github.com/viresh-ratnakar/exolve">Exolve (free, open source crossword-solving software used here) on GitHub</a></p>
    <p><a href="https://github.com/viresh-ratnakar/exet">Exet (free, open source crossword-setting software) on GitHub</a></p>
    <p><a href="https://exet.app/">Exet web app: start setting a crossword right away!</a></p>
    <p><a href="https://gussalufz.com/">Cryptic crosswords by Gussalufz</a></p>
  </div>
  <button id="xlvp-save" disabled onclick="xlvpSave()">
     Save Exolve-converted crossword as exolve-player-output.html
  </button>
  <details id="xlvp-view">
    <summary>
      View Exolve-formatted specs for the current crossword
    </summary>
    <pre id="xlvp-src">
      There isn't a current crossword. Perhaps open one?
    </pre>
  </details>
</div>

<script>

let xlvpFileName = '';
let xlvpData = '';

const xlvpFrame = document.getElementById('xlvp-frame');
const xlvpSrc = document.getElementById('xlvp-src');
const xlvpSaveButton = document.getElementById('xlvp-save');
const xlvpFile = document.getElementById('xlvp-file');
const xlvpText = document.getElementById('xlvp-text');
const xlvpW = document.getElementById('xlvp-w');
const xlvpH = document.getElementById('xlvp-h');
const xlvpChooser = document.getElementById('xlvp-chooser');
const xlvpChooserStrip = document.getElementById('xlvp-chooser-strip');

const xlvpStateKey = '42-xlvp-player-state';

function xlvpSaveState() {
  const state = {
    'data': xlvpData,
    'textW': xlvpW.value,
    'textH': xlvpH.value,
    'textData': xlvpText.value,
    'saveDisabled': xlvpSaveButton.disabled,
  };
  try {
    window.localStorage.setItem(xlvpStateKey, JSON.stringify(state));
  } catch (err) {
    console.log(err);
    console.log('Could not save stateâ€”local storage is full.');
  }
}

function xlvpRestoreState() {
  let state = window.localStorage.getItem(xlvpStateKey);
  if (!state) {
    return;
  }
  try {
    state = JSON.parse(state)
    if (state.textW) xlvpW.value = state.textW;
    if (state.textH) xlvpH.value = state.textH;
    if (state.textData) xlvpText.value = state.textData;
    if (state.data) {
      xlvpShowExolveInner(state.data, !state.saveDisabled, true);
    }
    console.log('Successfully restored exolve-player state');
  } catch (err) {
    console.log(err);
    console.log('Failed to parse exolve-player state');
  }
}

function xlvpDeleteOld(hideChooser=true) {
  for (id in exolvePuzzles) {
    if (isNaN(exolvePuzzles[id])) {
      delete exolvePuzzles[id];
    }
  }
  xlvpFrame.innerHTML = '';
  if (hideChooser) {
    xlvpChooser.style.display = 'none';
    xlvpChooserStrip.innerHTML = '';
  }
}

xlvpDeleteOld();
xlvpRestoreState();

function xlvpShowExolve(specs, converted=false, hideChooser=true) {
  const ret = xlvpShowExolveInner(specs, converted, hideChooser);
  if (ret) {
    xlvpSaveState();
  }
  return ret;
}

function xlvpShowExolveInner(specs, converted, hideChooser) {
  let start = specs.indexOf('exolve-begin')
  let end = specs.indexOf('exolve-end')
  if (start < 0 || end < 0 || start >= end) {
    return false;
  }
  while (start > 0 && specs.charAt(start - 1) == ' ') {
    start--;
  }
  const data = specs.substring(start, end) + 'exolve-end';

  xlvpDeleteOld(hideChooser);

  try {
    createExolve(data, 'xlvp-frame', false);
  } catch (err) {
    console.log(err);
    console.log('createExolve() failed');
    return false;
  }

  xlvpData = data;
  xlvpSrc.innerText = xlvpData;
  xlvpSaveButton.disabled = !converted;
  xlvpFrame.scrollIntoView();
  return true;
}

function xlvpSave() {
  const data = '' +
    '<!DOCTYPE html>\n' +
    '<html lang="en">\n' +
    '<head>\n' +
    '<meta charset="utf-8"/>\n' +
    '<meta name="viewport" content="width=device-width, initial-scale=1"/>\n' +
    '<link rel="stylesheet" type="text/css" ' +
    'href="https://viresh-ratnakar.github.io/exolve-m.css?v1.31"/>\n' +
    '<script src="https://viresh-ratnakar.github.io/exolve-m.js?v1.31">' +
    '<\/script>\n' +
    '<\/head>\n' +
    '<body>\n' +
    '<script>\n' +
    'createExolve(`' +
    `\n${xlvpData}` +
    '`);\n' +
    '<\/script>\n' +
    '<\/body>\n' +
    '<\/html>\n';
  const a = document.createElement("a");
  a.style.display = "none";
  document.body.appendChild(a);
  a.href = window.URL.createObjectURL(
    new Blob([data], {type: "text/html;charset=UTF-8"})
  );
  a.setAttribute("download", 'exolve-player-output.html');
  a.click();
  window.URL.revokeObjectURL(a.href);
  document.body.removeChild(a);
}

function xlvpShowIpuz(specs, fname) {
  let start = specs.indexOf('{')
  let end = specs.lastIndexOf('}')
  if (start < 0 || end < 0 || start >= end) {
    return false;
  }
  const ipuzJSON = specs.substring(start, end) + '}';
  try {
    const ipuz = JSON.parse(ipuzJSON);
    const exolve = exolveFromIpuz(ipuz, fname);
    if (!exolve) {
      return false;
    }
    return xlvpShowExolve(exolve, true);
  } catch (err) {
    console.log(err);
  }
  return false;
}
function xlvpShowPuz(buffer, fname) {
  const exolve = exolveFromPuz(buffer, fname);
  if (!exolve) {
    return false;
  }
  return xlvpShowExolve(exolve, true);
}
function xlvpShow(buffer, fname) {
  let utf8decoder = new TextDecoder();
  specs = utf8decoder.decode(buffer);
  if (xlvpShowExolve(specs)) {
    return;
  }
  if (xlvpShowIpuz(specs, fname)) {
    return;
  }
  if (xlvpShowPuz(buffer, fname)) {
    return;
  }
  if (xlvpShowText(specs)) {
    return;
  }
  alert('Could not read the crossword file');
}
function xlvpOpenFile(f) {
  let fr = new FileReader(); 
  fr.onload = function(){ 
    xlvpShow(fr.result, xlvpFileName);
  }
  xlvpFileName = f.name
  fr.readAsArrayBuffer(f)
}
function xlvpOnOpenFile(ev) {
  let f = xlvpFile.files[0];
  xlvpOpenFile(f);
}
function xlvpDrop(ev) {
  ev.preventDefault();

  let f = null;
  if (ev.dataTransfer.items && ev.dataTransfer.items.length > 0) {
    f = ev.dataTransfer.items[0].getAsFile();
  } else if (ev.dataTransfer.files.length > 0) {
    f = ev.dataTransfer.files[0];
  }
  if (!f) {
    return;
  }
  xlvpOpenFile(f);
}
function xlvpDrag(ev) {
  ev.preventDefault();
}

function xlvpOnText() {
  if (!xlvpShowText(xlvpText.value)) {
    alert('Could not infer a ' + xlvpW.value + 'x' + xlvpH.value + ' grid from the crossword text provided.');
  }
}

function xlvpShowText(text) {
  const w = xlvpW.value;
  const h = xlvpH.value;
  const specs = exolveFromText(w, h, text);

  if (!specs || specs.length == 0) {
    return false;
  }
  xlvpDeleteOld();
  if (specs.length > 1) {
    let html = '<table><tr>';
    for (let i = 0; i < specs.length; i++) {
      html += `<td id="xlvp-chooser-${i}" class="xlvp-chooser-entry"></td>`;
    }
    html += '</tr></table>'
    xlvpChooserStrip.innerHTML = html;
    for (let i = 0; i < specs.length; i++) {
      const smallSpecs = `
  exolve-begin
    exolve-width: ${w}
    exolve-height: ${h}
    exolve-option: ignore-unclued ignore-enum-mismatch
    exolve-grid:
      ${specs[i].grid}
  exolve-end`;
      const smallXlv = new Exolve(smallSpecs, `xlvp-chooser-${i}`, function(puz) {
        document.getElementById(puz.prefix + '-controls-etc').style.display = 'none';
        document.getElementById(puz.prefix + '-curr-clue-parent').style.display = 'none';
      }, false, 0, 150, false);
      const chooser = document.getElementById(`xlvp-chooser-${i}`);
      chooser.addEventListener('click', () => {
        xlvpShowExolve(specs[i].exolve, true, false);
        chooser.classList.add('xlvp-chooser-entry-sel');
        for (let j = 0; j < specs.length; j++) {
          if (j == i) {
            continue;
          }
          document.getElementById(`xlvp-chooser-${j}`).className = 'xlvp-chooser-entry';
        }
      });
    }
    xlvpChooser.style.display = '';
  } else {
    const spec = specs[0].exolve;
    xlvpShowExolve(spec, true);
  }
  return true;
}
</script>
</body>
</html>
